<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMS - BURBAN</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/admin.css">
    <script src="https://cdn.jsdelivr.net/npm/otpauth@9.1.4/dist/otpauth.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <!-- Login Section -->
    <section class="admin-login" id="adminLogin">
        <div class="container-small">
            <div class="admin-login-box">
                <img src="https://i.imgur.com/Kl9kTBg.png" alt="BURBAN" style="height: 40px; margin-bottom: 32px;">
                <h1>CMS Admin</h1>
                
                <form id="loginForm" class="admin-form">
                    <input type="email" id="adminEmail" placeholder="Email" required>
                    <input type="password" id="adminPassword" placeholder="Mot de passe" required>
                    <button type="submit" class="btn-primary">Se connecter</button>
                    <p class="form-error" id="loginError"></p>
                </form>
            </div>
        </div>
    </section>

    <!-- 2FA Section -->
    <section class="admin-2fa" id="admin2FA" style="display: none;">
        <div class="container-small">
            <div class="admin-login-box" style="max-width: 500px;">
                <img src="https://i.imgur.com/Kl9kTBg.png" alt="BURBAN" style="height: 40px; margin-bottom: 32px;">
                <h1>Authentification à deux facteurs</h1>
                
                <div id="qrCodeSection" style="display: none;">
                    <p style="color: var(--gray); margin-bottom: 24px;">Scannez ce QR code avec votre application d'authentification</p>
                    <div id="qrcode" style="display: flex; justify-content: center; margin-bottom: 24px;"></div>
                    <p style="font-size: 12px; color: var(--gray); margin-bottom: 24px;">Compatible avec Google Authenticator, Microsoft Authenticator, Authy, etc.</p>
                </div>
                
                <p style="color: var(--gray); margin-bottom: 16px;" id="codePrompt">Entrez le code à 6 chiffres</p>
                <form id="twoFAForm" class="admin-form">
                    <input type="text" id="twoFACode" placeholder="000000" maxlength="6" pattern="[0-9]{6}" required autocomplete="off">
                    <button type="submit" class="btn-primary">Vérifier</button>
                    <p class="form-error" id="twoFAError"></p>
                </form>
            </div>
        </div>
    </section>

    <!-- Admin Dashboard -->
    <section class="admin-dashboard" id="adminDashboard" style="display: none;">
        <nav class="admin-nav">
            <div class="admin-nav-container">
                <img src="https://i.imgur.com/Kl9kTBg.png" alt="BURBAN" style="height: 28px;">
                <button class="btn-secondary" id="logoutBtn">Déconnexion</button>
            </div>
        </nav>

        <div class="admin-container">
            <aside class="admin-sidebar">
                <a href="#" class="admin-menu-link active" data-section="products">Produits</a>
                <a href="#" class="admin-menu-link" data-section="categories">Catégories</a>
                <a href="#" class="admin-menu-link" data-section="sizeguides">Guides des tailles</a>
                <a href="#" class="admin-menu-link" data-section="orders">Commandes</a>
                <a href="#" class="admin-menu-link" data-section="users">Utilisateurs</a>
                <a href="#" class="admin-menu-link" data-section="settings">Paramètres</a>
            </aside>

            <div class="admin-content">
                <!-- Products Section -->
                <div class="admin-section active" id="productsSection">
                    <div class="admin-header">
                        <h2>Gestion des produits</h2>
                        <button class="btn-primary" id="addProductBtn">Ajouter un produit</button>
                    </div>
                    <div class="admin-table">
                        <table id="productsTable">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Nom</th>
                                    <th>Prix</th>
                                    <th>Catégorie</th>
                                    <th>Stock</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Size Guides Section -->
                <div class="admin-section" id="sizeguidesSection">
                    <div class="admin-header">
                        <h2>Guides des tailles</h2>
                        <button class="btn-primary" id="addSizeGuideBtn">Ajouter un guide</button>
                    </div>
                    <div class="admin-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Produits associés</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sizeguidesTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Categories Section -->
                <div class="admin-section" id="categoriesSection">
                    <div class="admin-header">
                        <h2>Gestion des catégories</h2>
                        <button class="btn-primary" id="addCategoryBtn">Ajouter une catégorie</button>
                    </div>
                    <div class="admin-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Slug</th>
                                    <th>Produits</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="categoriesTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Orders Section -->
                <div class="admin-section" id="ordersSection">
                    <div class="admin-header">
                        <h2>Commandes</h2>
                    </div>
                    <div class="admin-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Numéro</th>
                                    <th>Client</th>
                                    <th>Date</th>
                                    <th>Total</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Order Modal -->
                <div class="modal" id="orderModal">
                    <div class="modal-content">
                        <span class="modal-close">&times;</span>
                        <h3>Gérer la commande</h3>
                        <form id="orderForm" class="admin-form">
                            <input type="hidden" id="orderNumber">
                            <input type="text" id="orderTrackingUrl" placeholder="Lien de suivi colis">
                            <select id="orderStatus">
                                <option value="processing">En cours de traitement</option>
                                <option value="shipped">Envoyé</option>
                            </select>
                            <button type="submit" class="btn-primary">Enregistrer</button>
                        </form>
                    </div>
                </div>

                <!-- Users Section -->
                <div class="admin-section" id="usersSection">
                    <div class="admin-header">
                        <h2>Utilisateurs</h2>
                    </div>
                    <div class="admin-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Email</th>
                                    <th>Commandes</th>
                                    <th>Inscrit le</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Settings Section -->
                <div class="admin-section" id="settingsSection">
                    <div class="admin-header">
                        <h2>Paramètres</h2>
                    </div>
                    <form id="settingsForm" class="admin-form" style="max-width: 600px;">
                        <h3>Informations du site</h3>
                        <input type="text" placeholder="Nom du site" value="BURBAN">
                        <input type="email" placeholder="Email de contact" value="contact@burban.com">
                        <input type="text" placeholder="Téléphone" value="+33 1 23 45 67 89">
                        
                        <h3 style="margin-top: 32px;">Stripe</h3>
                        <input type="text" placeholder="Clé publique Stripe">
                        <input type="password" placeholder="Clé secrète Stripe">
                        
                        <button type="submit" class="btn-primary">Enregistrer</button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Product Modal -->
    <div class="modal" id="productModal">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <span class="modal-close">&times;</span>
            <h3 id="productModalTitle">Ajouter un produit</h3>
            <form id="productForm" class="admin-form">
                <input type="hidden" id="productId">
                <input type="text" id="productName" placeholder="Nom du produit" required>
                <input type="number" id="productPrice" placeholder="Prix (€)" step="0.01" min="0" required>
                <textarea id="productDescription" placeholder="Description" rows="3" required></textarea>
                
                <select id="productCategory" required>
                    <option value="">Catégorie</option>
                </select>
                
                <select id="productGender" required>
                    <option value="">Genre</option>
                    <option value="men">Homme</option>
                    <option value="women">Femme</option>
                </select>
                
                <h4 style="margin: 16px 0 8px; font-size: 14px; font-weight: 500;">Galerie d'images</h4>
                <input type="text" id="productImage1" placeholder="Image 1 (principale)" required>
                <input type="text" id="productImage2" placeholder="Image 2">
                <input type="text" id="productImage3" placeholder="Image 3">
                <input type="text" id="productImage4" placeholder="Image 4">
                
                <input type="text" id="productSizes" placeholder="Tailles (séparées par des virgules)" value="S,M,L,XL" required>
                <input type="text" id="productColors" placeholder="Couleurs hex (séparées par des virgules)" value="#000000,#FFFFFF" required>
                
                <select id="productSizeGuide">
                    <option value="">Guide des tailles (optionnel)</option>
                </select>
                
                <h4 style="margin: 16px 0 8px; font-size: 14px; font-weight: 500;">Informations produit</h4>
                <textarea id="productDetails" placeholder="Détails (ex: 100% coton bio, Coupe régulière, Fabriqué au Portugal)" rows="2"></textarea>
                <textarea id="productMaterials" placeholder="Matériaux (ex: Coton biologique certifié GOTS, Teinture sans produits chimiques)" rows="2"></textarea>
                <textarea id="productShipping" placeholder="Livraison (ex: Livraison gratuite dès 100€, Retours sous 30 jours)" rows="2"></textarea>
                
                <h4 style="margin: 16px 0 8px; font-size: 14px; font-weight: 500;">Dates de publication</h4>
                <input type="datetime-local" id="productPublishDate">
                <input type="datetime-local" id="productUnpublishDate" placeholder="Date de dépublication (optionnel)">
                
                <div id="stockVariantsContainer" style="margin-top: 16px;"></div>
                
                <h4 style="margin: 16px 0 8px; font-size: 14px; font-weight: 500;">Promotion</h4>
                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <input type="checkbox" id="productPromoActive" style="width: auto;">
                    <span style="font-size: 14px;">Activer la promotion</span>
                </label>
                <div id="promoFields" style="display: none;">
                    <input type="number" id="productOriginalPrice" placeholder="Prix initial (€)" step="0.01" min="0">
                    <label style="display: flex; align-items: center; gap: 8px; margin: 12px 0;">
                        <input type="checkbox" id="productPromoUnlimited" style="width: auto;">
                        <span style="font-size: 14px;">Réduction sans limite</span>
                    </label>
                    <input type="datetime-local" id="productPromoEndDate" placeholder="Date de fin de promotion">
                </div>
                
                <button type="submit" class="btn-primary">Enregistrer</button>
            </form>
        </div>
    </div>

    <!-- Category Modal -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <span class="modal-close" onclick="document.getElementById('categoryModal').classList.remove('active')">&times;</span>
            <h3>Ajouter une catégorie</h3>
            <form id="categoryForm" class="admin-form">
                <input type="text" id="categoryName" placeholder="Nom de la catégorie" required>
                <button type="submit" class="btn-primary">Enregistrer</button>
            </form>
        </div>
    </div>

    <!-- Size Guide Modal -->
    <div class="modal" id="sizeGuideModal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="modal-close">&times;</span>
            <h3 id="sizeGuideModalTitle">Ajouter un guide des tailles</h3>
            <form id="sizeGuideForm" class="admin-form">
                <input type="hidden" id="sizeGuideId">
                <input type="text" id="sizeGuideName" placeholder="Nom du guide (ex: T-shirts Homme)" required>
                
                <div style="margin: 16px 0;">
                    <label style="font-size: 14px; font-weight: 500; margin-bottom: 8px; display: block;">Colonnes (séparées par des virgules)</label>
                    <input type="text" id="sizeGuideColumns" placeholder="Taille, Poitrine (cm), Longueur (cm)" required>
                </div>
                
                <div style="margin: 16px 0;">
                    <label style="font-size: 14px; font-weight: 500; margin-bottom: 8px; display: block;">Lignes</label>
                    <div id="sizeGuideRows"></div>
                    <button type="button" class="btn-secondary" id="addRowBtn" style="margin-top: 8px;">+ Ajouter une ligne</button>
                </div>
                
                <button type="submit" class="btn-primary">Enregistrer</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, arrayUnion, updateDoc, deleteField, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyDb4AOtRT7jGENnLZ2KNwpczaG2Z77G2rc",
            authDomain: "burban-fidelity.firebaseapp.com",
            projectId: "burban-fidelity"
        };
        
        const app = initializeApp(firebaseConfig);
        window.firebaseDb = getFirestore(app);
        window.firebaseModules = { doc, getDoc, setDoc, deleteDoc, arrayUnion, updateDoc, deleteField, collection, getDocs };
        window.firebaseReady = true;
    </script>
    <script src="js/admin.js"></script>
    <script src="js/admin-functions.js"></script>
    <script src="js/admin-orders.js"></script>
    <script src="js/email-service.js"></script>
    <script>
        // Toggle promo fields
        document.getElementById('productPromoActive')?.addEventListener('change', (e) => {
            document.getElementById('promoFields').style.display = e.target.checked ? 'block' : 'none';
            if (!e.target.checked) {
                document.getElementById('productOriginalPrice').value = '';
                document.getElementById('productPromoEndDate').value = '';
                document.getElementById('productPromoUnlimited').checked = false;
            }
        });
        
        document.getElementById('productPromoUnlimited')?.addEventListener('change', (e) => {
            const endDateField = document.getElementById('productPromoEndDate');
            endDateField.disabled = e.target.checked;
            if (e.target.checked) endDateField.value = '';
        });
    </script>
</body>
</html>
