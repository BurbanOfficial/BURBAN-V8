<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commande confirmée - BURBAN</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <a href="index.html" class="logo"><img src="https://i.imgur.com/Kl9kTBg.png" alt="BURBAN"></a>
            <div class="nav-links">
                <a href="products.html?category=men" data-text="Men"><span class="link-text">Men</span></a>
                <a href="products.html?category=women" data-text="Women"><span class="link-text">Women</span></a>
                <a href="contact.html" data-text="Contact Us"><span class="link-text">Contact Us</span></a>
                <span class="nav-separator"></span>
                <a href="account.html" data-text="Account"><span class="link-text">Account</span></a>
                <a href="cart.html" class="cart-link" data-text="Cart"><span class="link-text">Cart</span> <span class="cart-count">0</span></a>
            </div>
        </div>
    </nav>

    <section class="success-page">
        <div class="container-small">
            <div class="success-content">
                <div class="success-icon">✓</div>
                <h1>Commande confirmée</h1>
                <p>Merci pour votre commande. Un email de confirmation vous a été envoyé.</p>
                <div class="success-actions">
                    <a href="account.html" class="btn-primary">Voir mes commandes</a>
                    <a href="products.html" class="btn-secondary">Continuer mes achats</a>
                </div>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <p class="footer-copy">&copy; 2024 BURBAN. Tous droits réservés.</p>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, updateDoc, arrayUnion, setDoc, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyDb4AOtRT7jGENnLZ2KNwpczaG2Z77G2rc",
            authDomain: "burban-fidelity.firebaseapp.com",
            projectId: "burban-fidelity",
            storageBucket: "burban-fidelity.firebasestorage.app",
            messagingSenderId: "830299174800",
            appId: "1:830299174800:web:f50a4ec419e108f7f16515",
            measurementId: "G-E4QD4PYLM5"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Attendre que l'utilisateur soit chargé
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                console.log('Aucun utilisateur connecté');
                return;
            }
            
            console.log('Utilisateur connecté:', user.uid);
            
            // Gérer les points après paiement validé
            const lastOrderData = sessionStorage.getItem('lastOrder');
            console.log('lastOrder data:', lastOrderData);
            
            if (lastOrderData) {
                const { order, voucher } = JSON.parse(lastOrderData);
                console.log('Order:', order, 'Voucher:', voucher);
                
                try {
                    // Générer numéro de commande BR + 9 chiffres + 2 lettres
                    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                    const orderNumber = 'BR' + String(Date.now()).slice(-9) + letters[Math.floor(Math.random() * 26)] + letters[Math.floor(Math.random() * 26)];
                    
                    // Déduire le stock
                    const productsSnapshot = await getDocs(collection(db, 'products'));
                    for (const item of order.items) {
                        const productDoc = productsSnapshot.docs.find(d => d.data().id === item.id);
                        if (productDoc) {
                            const product = productDoc.data();
                            const variantKey = `${item.color}-${item.size}`;
                            const currentStock = product.stockByVariant[variantKey] || 0;
                            product.stockByVariant[variantKey] = Math.max(0, currentStock - item.quantity);
                            await setDoc(doc(db, 'products', `${product.id}`), product);
                        }
                    }
                    
                    // Créer la commande dans Firestore
                    const orderData = {
                        orderNumber,
                        userId: user.uid,
                        userEmail: user.email,
                        items: order.items,
                        total: order.total,
                        discount: voucher ? voucher.discount : 0,
                        voucherPoints: voucher ? voucher.points : 0,
                        status: 'processing',
                        trackingUrl: null,
                        date: new Date().toISOString(),
                        shippingAddress: order.shippingAddress || null,
                        billingAddress: order.billingAddress || null,
                        cardLast4: order.cardLast4 || 'XXXX'
                    };
                    await setDoc(doc(db, 'orders', orderNumber), orderData);
                    
                    // Mettre à jour les points utilisateur
                    const userRef = doc(db, 'users', user.uid);
                    const userDoc = await getDoc(userRef);
                    const userData = userDoc.data();
                    
                    const currentPoints = userData.points || 0;
                    const pointsEarned = Math.floor(order.total * 10);
                    let newPoints = currentPoints + pointsEarned;
                    
                    const updates = [];
                    
                    if (voucher) {
                        newPoints -= voucher.points;
                        updates.push({
                            points: -voucher.points,
                            description: `Échange de ${voucher.points} points contre un bon de ${voucher.discount}€`,
                            date: new Date().toISOString()
                        });
                    }
                    
                    updates.push({
                        points: pointsEarned,
                        description: `Ajout de ${pointsEarned} points suite à votre achat`,
                        date: new Date().toISOString()
                    });
                    
                    await updateDoc(userRef, {
                        points: newPoints,
                        pointsHistory: arrayUnion(...updates),
                        orders: arrayUnion(orderNumber)
                    });
                    
                    console.log('Commande créée:', orderNumber);
                    sessionStorage.removeItem('lastOrder');
                } catch (error) {
                    console.error('Erreur mise à jour points:', error);
                }
            }
        });
    </script>
    <script src="js/app.js"></script>
</body>
</html>
